image: node:16.5.0

stages:
  - build
  - deploy

variables:
  SOURCEMAP_BASE_URL: https://lucidac-gui.anabrid.dev/main/

default:
  cache:
    key:
      files:
        - package-lock.json
      prefix: npm
    paths:
      - node_modules/

build_headless:
  stage: build
  script:
    - npm install
    - ENDPOINT="" npm run build
    - cp *.md dist/
#    - cd dist && tar cvfz lucidac-gui-headless.tar.gz .
#    - echo ANABRID_BUILD_JOB_ID=$CI_JOB_ID > .anabrid_build_result.env
  artifacts:
    paths:
      - dist
#    reports:
#      dotenv: .anabrid_build_result.env

build_for_teensy:
  stage: build
  script:
    - npm install
    - npm run build
    - cp *.md dist/
#    - cd dist && tar cvfz lucidac-gui-teensy.tar.gz .
#    - echo ANABRID_BUILD_JOB_ID=$CI_JOB_ID > .anabrid_build_result.env
  artifacts:
    paths:
      - dist
#    reports:
#      dotenv: .anabrid_build_result.env

upload_headless_to_webserver:
  stage: deploy
  image: svenk/latex
  needs:
    - build_headless
  script:
    - chmod 600 "$SSH_PRIVATE_KEY_FILE_STAGING"
    - echo "ai.svenk.org ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBE2YTwpWWq4ceRXHbCFHlw5kmRVLQjKbdYeFAAyYUDXFRhCjRknE6DKlGIIciKOqzAMiFGz5/vxb6tKMCKBeFU0=" > ~/userknown.txt
    - echo -e "cd anabrid.dev/lucidac-gui/main/\nput -R dist/*" | sftp -o "UserKnownHostsFile=~/userknown.txt" -i"$SSH_PRIVATE_KEY_FILE_STAGING" $DEPLOY_STAGING_SSH_HOST

#
#gitlab_release:
#  stage: deploy
#  image: registry.gitlab.com/gitlab-org/release-cli:latest
#  rules:
#    - if: $CI_COMMIT_TAG
#  needs:
#    - job: build_headless
#      artifacts: true
#    - job: build_for_teensy
#      artifacts: true
#  script:
#    - echo "Releasing artifacts built in build_job ${ANABRID_BUILD_JOB_ID}."
#  release:
#    name: 'LUCIDAC Firmware v$CI_COMMIT_TAG'
#    description: 'LUCIDAC firmware release version $CI_COMMIT_TAG.'
#    # tag_name is a mendatory field and can not be an empty string
#    tag_name: '$CI_COMMIT_TAG'
#    assets:
#      links:
#        - name: 'Firmware binary hex file'
#          url: '$CI_PROJECT_URL/-/jobs/${ANABRID_BUILD_JOB_ID}/artifacts/raw/dist/dist.tar.gz'
#          link_type: package
